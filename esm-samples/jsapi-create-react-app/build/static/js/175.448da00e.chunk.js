(this["webpackJsonpjsapi-create-react-app"]=this["webpackJsonpjsapi-create-react-app"]||[]).push([[175],{1166:function(e,t,i){"use strict";i.r(t);var s=i(0),r=i(11),n=i(23),a=i(1),l=(i(8),i(9),i(7)),o=i(4),h=i(84),d=i(10),c=i(12),u=i(3),_=i(5),g=i(79);function x(e){return Object(g.b)(`esri/libs/vxl/${e}`)}var v=i(233);const b=l.a.getLogger(" esri.layers.VoxelWasmPerScene");var y=class{constructor(e){this._useDepthPass=!1,this._havePreparedWithAllLayers=!1,this._renderPluginContext=null,this._vxl=null,this._pluginIsActive=!1,this._moreToLoad=!1,this._viewportWidth=-1,this._viewportHeight=-1,this._newLayers=[],this._layers=new Map,this._renderPass=0,this._renderSlot=4,this._rctx=null,this._renderTargetToRestore=null,this._dbgFlags=new Set,this._dbgFlags.add(4),this._view=e,this.initialize()}get canRender(){return!!this._vxl&&"local"===this._view.viewingMode}dbg(e,t){this._dbgFlags.has(e)&&(4===e?b.error(t):b.warn(t))}removeRenderPlugin(){this._pluginIsActive&&this._view._stage&&(this.dbg(1,"--removeRenderPlugin--"),this._view._stage.removeRenderPlugin(this)),this._pluginIsActive=!1}initialize(){this.dbg(1,"--initialize--"),this._readyWatchHandle=Object(n.a)(this._view,"ready",(e=>{e&&"local"===this._view.viewingMode?(this.dbg(1,"view ready status changed to ready on a local view, calling addRenderPlugin"),this._view._stage.addRenderPlugin([this._renderSlot],this),this._pluginIsActive=!0):(this.dbg(1,"view ready status changed, not ready or not a local view!"),this.removeRenderPlugin())})),this._qualityWatchHandle=Object(n.a)(this._view,"qualityProfile",(e=>{this.dbg(3,"qualityProfile changed to "+e),this._vxl&&this._vxl.set_quality(this.toWasmQuality(e))}))}initializeRenderContext(e){this.dbg(1,"--initializeRenderContext--");const t=e.renderContext.rctx;"webgl2"===t.webglVersion?(this._renderPluginContext=e,this._rctx=e.renderContext.rctx,this.initializeWasm(t.gl)):this.dbg(4,"WebGL 1 context only!")}uninitializeRenderContext(){this._renderPluginContext=null,this._rctx=null,this.dbg(1,"--uninitializeRenderContext--")}restoreFramebuffer(){if(!this._renderTargetToRestore)return;const e=this._renderTargetToRestore.fbo;if(!this._rctx)return void this.dbg(4,"no context in restoreFramebuffer!");this._rctx.bindFramebuffer(e,!0);const t=this._renderTargetToRestore.viewport;this._rctx.setViewport(t.x,t.y,t.width,t.height)}bindPreviousDepthToSlot(e,t){const i=!!this._rctx,s=!!this._renderTargetToRestore;if(!i||!s)return 0;const r=this._renderTargetToRestore.fbo.depthStencilTexture;return r?(0===t?this._rctx.bindTexture(null,e,!0):this._rctx.bindTexture(r,e,!0),1):(this.dbg(4,"no depth/stencil texture exists!"),0)}setBlendState(e,t,i,s){this._rctx?(this._rctx.setBlendingEnabled(1===e),this._rctx.setBlendFunction(t,i),this._rctx.setBlendEquation(s)):this.dbg(4,"setBlendState callback has no rendering context!")}setFrontFace(e){this._rctx?this._rctx.setFrontFace(e):this.dbg(4,"setFrontFace callback has no rendering context!")}setDepthStencilStateFunction(e,t,i){this._rctx?(this._rctx.setDepthFunction(i),this._rctx.setDepthTestEnabled(1===e),this._rctx.setDepthWriteEnabled(1===t),this._rctx.setStencilTestEnabled(!1),this._rctx.setStencilFunction(519,0,255),this._rctx.setStencilOpSeparate(1028,7680,7682,7680),this._rctx.setStencilOpSeparate(1029,7680,7683,7680)):this.dbg(4,"setDepthStencilStateFunction callback has no rendering context!")}setRasterizerState(e){if(this._rctx)switch(e){case 1:this._rctx.setFaceCullingEnabled(!1);break;case 3:this._rctx.setCullFace(1029),this._rctx.setFaceCullingEnabled(!0);break;case 2:this._rctx.setCullFace(1028),this._rctx.setFaceCullingEnabled(!0)}else this.dbg(4,"setRasterizerState callback has no rendering context!")}setViewport(e,t,i,s){this._rctx?this._rctx.setViewport(e,t,i,s):this.dbg(4,"setViewport callback has no rendering context!")}syncRequestsResponses(){this._layers.forEach(((e,t)=>{const i=[];e.responses.forEach(((e,s)=>{i.push(s),this.dbg(2,"responding for requestID:"+s+" size:"+e.size),this._vxl.respond(t,s,e)}));const s=e.responses;for(const a of i)s.delete(a);const r=this._vxl.get_new_requests(t),n=e.abortController.signal;for(const a in r){e.outstandingRequestCount+=1,1===e.outstandingRequestCount&&e.layerView.updatingFlagChanged();const t=r[a],i={responseType:"array-buffer",signal:n};this.dbg(2,"making requestID:"+a+" url:"+t.url),Object(h.default)(t.url,i).then((i=>{e.outstandingRequestCount-=1,0===e.outstandingRequestCount&&e.layerView.updatingFlagChanged(),this.dbg(2,"have response for requestID:"+a);let r=0;if(i.data.byteLength>0){r=this._vxl._malloc(i.data.byteLength);const e=new Uint8Array(this._vxl.HEAPU8.buffer,r,i.data.byteLength),t=new Uint8Array(i.data);for(let s=0;s<i.data.byteLength;++s)e[s]=t[s]}s.set(+a,{type:t.type,ptr:r,size:i.data.byteLength,success:!0})})).catch((i=>{e.outstandingRequestCount-=1,0===e.outstandingRequestCount&&e.layerView.updatingFlagChanged(),Object(c.n)(i)||(this.dbg(4,"requestID:"+a+" failed"),s.set(+a,{type:t.type,ptr:0,size:0,success:!1}))}))}}))}updateWasmCamera(e){this._vxl.set_projection_matrix.apply(this._vxl,e.projectionMatrix),this._vxl.set_view_matrix.apply(this._vxl,e.viewMatrix),this._vxl.set_near_far(e.near,e.far)}isUpdating(e){return!(this._vxl||!this._vxlPromise)||!!this._layers.has(e)&&this._layers.get(e).outstandingRequestCount>0}setEnabled(e,t){this._layers.forEach(((i,s)=>{i.layerView===e&&(this._vxl.set_enabled(s,t?1:0),this._renderPluginContext.requestRender())}))}addVoxelLayer(e){if(!this._vxl){const t={layerView:e,resolveCallback:"",rejectCallback:""},i=new Promise(((e,i)=>{t.resolveCallback=e,t.rejectCallback=i}));return this._newLayers.push(t),i}const t=this._addVoxelLayer(e);return t<0?Promise.reject(-1):Promise.resolve(t)}removeVoxelLayer(e){if(!this._vxl){const t=this._newLayers.findIndex((t=>e===t.layerView));t>=0&&(this._newLayers[t].resolveCallback(-1),this._newLayers.splice(t,1));const i=this._newLayers.length;return 0===i&&(this.dbg(1," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),i}let t=-1;this._layers.forEach(((i,s)=>{i.layerView===e&&(t=s,i.abortController.abort(),this._vxl.remove_layer(t))})),t>=0&&this._layers.delete(t);const i=this._layers.size;return 0===i&&(this.dbg(1," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),i}_addVoxelLayer(e){const t=e.layer;let i=-1;const s=t.layerData;if(s&&s.data.byteLength>0){const e=this._vxl._malloc(s.data.byteLength),r=new Uint8Array(this._vxl.HEAPU8.buffer,e,s.data.byteLength),n=new Uint8Array(s.data);for(let t=0;t<s.data.byteLength;++t)r[t]=n[t];const a=32662===this._view.spatialReference.wkid&&t.spatialReference.isWGS84?111319.49079327357:1;i=this._vxl.add_layer(t.serviceRoot,e,s.data.byteLength,a,a),this._vxl._free(e)}if(i>=0){const t=Object(c.e)();return this._layers.set(i,{layerView:e,responses:new Map,outstandingRequestCount:0,abortController:t}),i}return-1}prepareRender(e){if(!this._vxl)return;const t=e.viewForward,i=e.eye;this._vxl.update_camera_pos_and_direction(i[0],i[1],i[2],t[0],t[1],t[2]);const s=this._vxl.cull();this.dbg(2,"missingResourceCount="+s),this._moreToLoad=s>0,this._havePreparedWithAllLayers=0===this._newLayers.length}render(e){if(!this._vxl)return!1;for(const i of this._newLayers){const e=this._addVoxelLayer(i.layerView);-1===e?i.rejectCallback(-1):i.resolveCallback(e)}if(this._newLayers=[],e.pass!==this._renderPass)return!1;if(e.slot!==this._renderSlot)return!1;if(0===this._layers.size)return this.dbg(4,"No voxel layers but RenderPlugin instance is being asked to render!"),!0;this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()},this.syncRequestsResponses(),this._vxl.begin_frame();const t=this._renderTargetToRestore.viewport;return t.width===this._viewportWidth&&t.height===this._viewportHeight||(this._viewportWidth=t.width,this._viewportHeight=t.height,this._vxl.set_viewport(t.width,t.height)),0===t.x&&0===t.y||this.dbg(4,"Unsupported viewport parameters detected!"),this.updateWasmCamera(e.camera),this._vxl.draw(),this._renderTargetToRestore.fbo=null,e.rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),e.rctx.externalVertexArrayObjectUpdate(),e.rctx.externalVertexBufferUpdate(),(this._moreToLoad||!this._havePreparedWithAllLayers&&this._layers.size>0)&&this._renderPluginContext.requestRender(),!0}queryDepthRange(e){this.dbg(1,"--queryDepthRange--");const t=e.viewForward,i=e.eye;this._vxl.update_camera_pos_and_direction(i[0],i[1],i[2],t[0],t[1],t[2]),this._vxl.cull();const s={near:5,far:1e4};return s.near=this._vxl.get_near(),s.far=this._vxl.get_far(),s}destroy(){this.dbg(1,"--destroy--"),this.removeRenderPlugin(),this._readyWatchHandle&&(this._readyWatchHandle.remove(),this._readyWatchHandle=null),this._qualityWatchHandle&&(this._qualityWatchHandle.remove(),this._qualityWatchHandle=null),this._vxl&&(this._vxl.uninitialize_voxel_wasm(),this._vxl=null)}initializeWasm(e){return this._vxl?Promise.resolve():(this._vxlPromise||(this._vxlPromise=function(e){return new Promise((t=>i.e(149).then(i.bind(null,1149)).then((function(e){return e.v})).then((({default:i})=>{const s=i({locateFile:x,preinitializedWebGLContext:e,onRuntimeInitialized:()=>t(s)})})))).catch((e=>Promise.reject(e)))}(e).then((e=>{if(this._vxl=e,this._vxlPromise=null,this._newLayers.length<=0)return this.dbg(1," no voxel layers left after WASM downloaded, removing RenderPlugin and destroying"),void this.destroy();const t=this._vxl.addFunction(this.restoreFramebuffer.bind(this),"v"),i=this._vxl.addFunction(this.setBlendState.bind(this),"viiii"),s=this._vxl.addFunction(this.setFrontFace.bind(this),"vi"),r=this._vxl.addFunction(this.setRasterizerState.bind(this),"vi"),n=this._vxl.addFunction(this.setDepthStencilStateFunction.bind(this),"viii"),a=this._vxl.addFunction(this.setViewport.bind(this),"viiii"),l=this._vxl.addFunction(this.bindPreviousDepthToSlot.bind(this),"iii");this._vxl.initialize_voxel_wasm(t,i,s,r,n,a,l),this._vxl.set_quality(this.toWasmQuality(this._view.qualityProfile)),this._renderPluginContext&&this._renderPluginContext.requestRender()})).catch((()=>{for(const e of this._newLayers)e.rejectCallback(-2);this.dbg(4," WASM failed to download, removing RenderPlugin and destroying"),this.destroy()}))),this._vxlPromise)}get type(){return"external"}get isGround(){return!1}get slicePlane(){return!1}get intersectionHandlerId(){return"unj"}intersect(e,t,i,s,r){if(!this._vxl)return;if(!this._rctx)return;if(0===this._layers.size)return;if(r[0]<0||r[0]>e.camera.viewport[2]||r[1]<0||r[1]>e.camera.viewport[3])return;this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()};const n=e.camera.viewForward,a=e.camera.eye;this._vxl.update_camera_pos_and_direction(a[0],a[1],a[2],n[0],n[1],n[2]),this.updateWasmCamera(e.camera),this._vxl.begin_frame(),this._useDepthPass?this.intersectDepth(e,t,i,s,r):this.intersectObject(e,t,i,s,r),this._renderTargetToRestore.fbo=null,this._rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),this._rctx.externalVertexArrayObjectUpdate(),this._rctx.externalVertexBufferUpdate()}intersectObject(e,t,i,s,r){const n=this._vxl.pick_object(r[0],r[1]);if(n.success){const r=Object(_.e)();Object(u.C)(r,s,i),Object(u.t)(r,r);const a=Object(u.o)(i,s),l=Object(_.e)();Object(u.y)(l,n.worldX,n.worldY,n.worldZ);const o=Object(_.e)();Object(u.C)(o,l,i);const h=Object(_.e)();Object(u.g)(h,r,Object(u.j)(o,r));const c=Object(_.e)();Object(u.h)(c,i,h);const g=Object(u.o)(i,c),x=Object(d.e)(g/a,0,1),b=e=>{e.intersector="Voxel",e.dist=x,e.target={type:"external",metadata:{layerUid:this.intersectionHandlerId}}},y=e.results.min;(null==y.dist||x<y.dist)&&(null==t||t(i,s,x))&&b(y);const p=e.results.max;if(0!==e.options.store&&(null==p.dist||x>p.dist)&&(null==t||t(i,s,x))&&b(p),2===e.options.store){const t=new v.a(e.ray);b(t),e.results.all.push(t)}}}intersectDepth(e,t,i,s,r){const n=this._vxl.pick_depth(r[0],r[1]);if(n.success){const r=Object(_.e)();Object(u.C)(r,s,i),Object(u.t)(r,r);const a=Object(u.o)(i,s),l=Object(_.e)();Object(u.y)(l,n.worldX,n.worldY,n.worldZ);const o=Object(_.e)();Object(u.C)(o,l,i);const h=Object(_.e)();Object(u.g)(h,r,Object(u.j)(o,r));const c=Object(_.e)();Object(u.h)(c,i,h);const g=Object(u.o)(i,c),x=Object(d.e)(g/a,0,1),b=e=>{e.intersector="Voxel",e.dist=x,e.target={type:"external",metadata:{layerUid:this.intersectionHandlerId}}},y=e.results.min;(null==y.dist||x<y.dist)&&(null==t||t(i,s,x))&&b(y);const p=e.results.max;if(0!==e.options.store&&(null==p.dist||x>p.dist)&&(null==t||t(i,s,x))&&b(p),2===e.options.store){const t=new v.a(e.ray);b(t),e.results.all.push(t)}}}toWasmQuality(e){switch(e){case"low":return 0;case"medium":return 1;case"high":return 2}}};class p{constructor(){this.view2WASM=new Map}static getInstance(){return p.instance||(p.instance=new p),p.instance}isUpdating(e,t){return!!this.view2WASM.has(e)&&this.view2WASM.get(e).isUpdating(t)}addLayer(e,t){return this.view2WASM.has(e)||this.view2WASM.set(e,new y(e)),this.view2WASM.get(e).addVoxelLayer(t)}removeLayer(e,t){this.view2WASM.has(e)&&this.view2WASM.get(e).removeVoxelLayer(t)<1&&this.view2WASM.delete(e)}setLayerEnabled(e,t,i){this.view2WASM.has(e)&&this.view2WASM.get(e).setEnabled(t,i)}}var w=p,f=i(564),m=i(562);let j=class extends(Object(f.a)(m.a)){constructor(){super(...arguments),this.type="voxel-3d",this._wasmLayerId=-1}initialize(){if("local"!==this.view.viewingMode)throw new r.a("voxel:unsupported-viewingMode","Voxel layers support local viewingMode only.",{});if("webgl"===this.view.renderContext)throw new r.a("voxel:unsupported-context","Voxel layers are supported in WebGL2 rendering contexts only.",{});const e=w.getInstance(),t=e.addLayer(this.view,this).then((e=>{this._wasmLayerId=e,this._suspendedHandle=Object(n.a)(this,"suspended",(e=>{w.getInstance().setLayerEnabled(this.view,this,!e)}))})).catch((t=>{if(e.removeLayer(this.view,this),this._wasmLayerId=-1,-1===t)throw new r.a("voxel:addLayer-failure","The voxel layer description was invalid.",{});if(-2===t)throw new r.a("voxel:addLayer-failure","The voxel layer web assembly module failed to download.",{})}));this.addResolvingPromise(t)}destroy(){w.getInstance().removeLayer(this.view,this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null)}isUpdating(){return!(this._wasmLayerId<0)&&w.getInstance().isUpdating(this.view,this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}};Object(s.a)([Object(a.b)()],j.prototype,"layer",void 0),Object(s.a)([Object(a.b)({readOnly:!0,aliasOf:"layer.parsedUrl.path"})],j.prototype,"baseUrl",void 0),j=Object(s.a)([Object(o.a)("esri.views.3d.layers.VoxelLayerView3D")],j);var R=j;t.default=R}}]);
//# sourceMappingURL=175.448da00e.chunk.js.map